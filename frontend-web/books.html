<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>SIMPUS - Books</title>
  <link rel="stylesheet" href="./assets/css/main.css" />
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="side-card">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div class="brand-title">SIMPUS</div>
            <div class="brand-sub">Digital Library System</div>
          </div>
        </div>
        <nav class="nav">
          <a href="./dashboard.html">üè† Dashboard <small>Home</small></a>

          <!-- Member -->
          <a id="navBooksMember" href="./books.html" style="display:none;">üìö Katalog Buku <small>Browse</small></a>

          <!-- Admin -->
          <a id="navBooksAdmin" href="./books.html" style="display:none;">üìö Kelola Buku <small>Manage</small></a>

          <a href="./loans.html">üßæ Loans <small>History</small></a>
        </nav>

        <div class="hr"></div>
        <div class="muted" id="sideUser">Loading...</div>
      </div>
    </aside>

    <div>
      <div class="topbar">
        <div class="topbar-left">
          <div class="brand">
            <div class="logo"></div>
            <div>
              <div class="brand-title">Books</div>
              <div class="brand-sub">Cari, lihat, dan kelola buku</div>
            </div>
          </div>
        </div>
        <div>
          <a class="btn ghost small" href="./dashboard.html">Dashboard</a>
          <a class="btn ghost small" href="./loans.html">Loans</a>
          <button id="btnLogout" class="btn small">Logout</button>
        </div>
      </div>

      <main class="main">
        <div class="container">
          <div class="card">
            <div class="row">
              <div>
                <h1 id="pageTitle">Books</h1>
                <p class="muted" id="pageDesc">Gunakan search untuk memfilter judul/author/isbn.</p>
              </div>
              <button id="btnAdd" class="btn small" style="display:none;">+ Tambah Buku</button>
            </div>

            <div class="row">
              <div class="row-left">
                <input id="search" placeholder="Cari title/author/isbn..." style="width:320px; max-width:100%;" />
                <button id="btnSearch" class="btn small">Search</button>
                <button id="btnReset" class="btn ghost small">Reset</button>
              </div>
              <div class="row-left">
                <button id="prev" class="btn ghost small">Prev</button>
                <span class="badge" id="pageInfo">Page -</span>
                <button id="next" class="btn ghost small">Next</button>
              </div>
            </div>

            <div id="error" class="error" style="display:none;"></div>

            <table class="table" id="tableBooks">
              <thead>
                <tr>
                  <th style="width:70px;">ID</th>
                  <th>Judul</th>
                  <th>Author</th>
                  <th>Kategori</th>
                  <th style="width:120px;">Stok</th>
                  <th style="width:160px;">Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { requireAuth } from "./assets/js/guard.js";
    import { getUser, logout } from "./assets/js/auth.js";
    import { apiFetch } from "./assets/js/api.js";

    await requireAuth();

    const user = getUser();
    document.getElementById("sideUser").textContent = `${user?.name} ‚Ä¢ ${user?.role}`;

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await logout();
      window.location.href = "./login.html";
    });

    const btnAdd = document.getElementById("btnAdd");
    if (user?.role === "admin") {
      btnAdd.style.display = "inline-block";
      btnAdd.addEventListener("click", () => window.location.href = "./book-form.html");
    }

    const tbody = document.querySelector("#tableBooks tbody");
    const errorBox = document.getElementById("error");
    const searchInput = document.getElementById("search");
    const btnSearch = document.getElementById("btnSearch");
    const btnReset = document.getElementById("btnReset");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const pageInfo = document.getElementById("pageInfo");

    let page = 1;
    const perPage = 10;
    let lastPage = 1;

    function showError(msg) {
      errorBox.style.display = msg ? "block" : "none";
      errorBox.textContent = msg || "";
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    async function loadBooks() {
      showError("");
      tbody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;

      const search = searchInput.value.trim();
      const qs = new URLSearchParams({ page, per_page: perPage });
      if (search) qs.set("search", search);

      try {
        const res = await apiFetch(`/books?${qs.toString()}`);
        const paged = res.data;
        lastPage = paged.last_page;

        pageInfo.textContent = `Page ${paged.current_page} / ${paged.last_page}`;

        tbody.innerHTML = "";
        if (!paged.data.length) {
          tbody.innerHTML = `<tr><td colspan="6">Tidak ada data</td></tr>`;
          return;
        }

        for (const b of paged.data) {
          const cat = b.category?.name ?? "-";
          const stok = `${b.stock_available}/${b.stock_total}`;

          const actions = [];
          actions.push(`<a href="./book-detail.html?id=${b.id}">Detail</a>`);
          if (user?.role === "admin") {
            actions.push(` | <a href="./book-form.html?id=${b.id}">Edit</a>`);
            actions.push(` | <a href="#" data-del="${b.id}">Delete</a>`);
          }

          tbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${b.id}</td>
              <td>${escapeHtml(b.title)}</td>
              <td>${escapeHtml(b.author)}</td>
              <td>${escapeHtml(cat)}</td>
              <td><span class="badge">${stok}</span></td>
              <td class="actions">${actions.join("")}</td>
            </tr>
          `);
        }

        tbody.querySelectorAll("[data-del]").forEach(a => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const id = a.getAttribute("data-del");
            if (!confirm(`Hapus buku ID ${id}?`)) return;

            try {
              await apiFetch(`/books/${id}`, { method: "DELETE" });
              await loadBooks();
            } catch (err) {
              showError(err.message);
            }
          });
        });

      } catch (err) {
        tbody.innerHTML = "";
        showError(err.message);
      }
    }

    btnSearch.addEventListener("click", () => { page = 1; loadBooks(); });
    btnReset.addEventListener("click", () => { searchInput.value = ""; page = 1; loadBooks(); });
    prevBtn.addEventListener("click", () => { if (page > 1) { page--; loadBooks(); } });
    nextBtn.addEventListener("click", () => { if (page < lastPage) { page++; loadBooks(); } });

    await loadBooks();

    const pageTitle = document.getElementById("pageTitle");
    const pageDesc = document.getElementById("pageDesc");

    if (user?.role === "admin") {
      pageTitle.textContent = "Kelola Buku";
      pageDesc.textContent = "Admin dapat menambah, mengedit, dan menghapus buku.";
    } else {
      pageTitle.textContent = "Katalog Buku";
      pageDesc.textContent = "Member dapat melihat detail dan meminjam buku jika tersedia.";
    }

    const navBooksMember = document.getElementById("navBooksMember");
    const navBooksAdmin = document.getElementById("navBooksAdmin");

    if (user?.role === "admin") {
      navBooksAdmin.style.display = "flex";
    } else {
      navBooksMember.style.display = "flex";
    }

  </script>
</body>

</html>